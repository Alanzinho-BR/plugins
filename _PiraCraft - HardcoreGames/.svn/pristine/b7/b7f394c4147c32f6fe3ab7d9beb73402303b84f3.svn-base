package me.douglasamv.hg.Timer;

import java.util.ArrayList;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Sound;
import org.bukkit.entity.Player;
import org.bukkit.potion.PotionEffect;
import org.bukkit.potion.PotionEffectType;
import org.bukkit.scoreboard.Objective;
import org.bukkit.scoreboard.Scoreboard;
import org.bukkit.scoreboard.ScoreboardManager;

import me.douglasamv.hg.Main;
import me.douglasamv.hg.Manager.IniciandoEvt;
import me.douglasamv.hg.api.ScoreBoardBolada;

public class Iniciando {

	public static Scoreboard getScoreBoard() {
		ScoreboardManager manager = Bukkit.getScoreboardManager();
		Scoreboard board = manager.getNewScoreboard();
		return board;
	}

	public static Integer ReIniciando = Integer.valueOf(180);
	public static ArrayList<String> RelogPreGame = new ArrayList<String>();
	private static Integer shed_id = null;
	public Objective o;

	public Iniciando() {
		if (Main.PreGame) {
			shed_id = Bukkit.getServer().getScheduler().scheduleSyncRepeatingTask(Main.instance, new Runnable() {
				public void run() {
					if(Main.Jogadores.size() < Main.MinimoJogadores) {
						Main.TimerIniciando = 180;
						for (Player p : Bukkit.getOnlinePlayers()) {
							if(!ScoreBoardBolada.score.contains(p.getName())) {
								ScoreBoardBolada.scoreBoard(p);
							}
						}
						return;
					}
					if (Main.TimerIniciando > 0) {
						if (Main.TimerIniciando >= 30 & Main.TimerIniciando % 30 == 0) {
							for (Player pl : Bukkit.getOnlinePlayers()) {
								pl.setHealth(20);
								pl.setFoodLevel(20);
								pl.setExp(0);
								pl.setRemainingAir(20);
							}
							
							if ((Main.PreGame) && (Main.TimerIniciando == 180)) {
								Bukkit.broadcastMessage(
										"§eA Partida inicia em " + ChatColor.WHITE + "3 Minutos!");
							}
							if ((Main.PreGame) && (Main.TimerIniciando == 120)) {
								Bukkit.broadcastMessage(
										"§7[§a!§7] A Partida inicia em " + ChatColor.WHITE + "2 Minutos!");
							}
							if ((Main.PreGame) && (Main.TimerIniciando == 60)) {
								Bukkit.broadcastMessage(
										"§7[§a!§7] A Partida inicia em " + ChatColor.WHITE + "1 Minuto!");
							}
							if ((Main.PreGame) && (Main.TimerIniciando == 30)) {
								Bukkit.broadcastMessage(
										"§7[§a!§7] A Partida inicia em " + ChatColor.WHITE + "30 Segundos!");
							}
							if ((Main.PreGame) && (Main.TimerIniciando == 10)) {
								Bukkit.broadcastMessage(
										"§7[§a!§7] A Partida inicia em " + ChatColor.WHITE + "10 Segundos!");
							}
						}
						if ((Main.PreGame) && (Main.TimerIniciando < 6)) {
							Bukkit.broadcastMessage("§7[§a!§7] A Partida inicia em " + ChatColor.WHITE
									+ StringTimer.TimerGame(Integer.valueOf(Main.TimerIniciando)));
							for (Player pl : Bukkit.getOnlinePlayers()) {
								if (Main.Jogadores.contains(pl.getName())) {
									pl.setAllowFlight(false);
									pl.setFlying(false);
									IniciandoEvt.onTeleport();
									pl.playSound(pl.getLocation(), Sound.CLICK, 1.0F, (byte) 1);
									IniciandoEvt.Teleportar = true;
									RelogPreGame.add(pl.getName());
									pl.addPotionEffect(new PotionEffect(PotionEffectType.SLOW, 120, 50));
									pl.addPotionEffect(new PotionEffect(PotionEffectType.NIGHT_VISION, 120, 50));
									pl.addPotionEffect(new PotionEffect(PotionEffectType.JUMP, 120, 1000));
								}
							}
						}
						Main.TimerIniciando--;
						if (Main.PreGame) {
							for (Player p : Bukkit.getOnlinePlayers()) {
								if(!ScoreBoardBolada.score.contains(p.getName())) {
									ScoreBoardBolada.scoreBoard(p);
								}

							}
						}
					} else if ((Main.PreGame) && (Main.Jogadores.size() < Main.MinimoJogadores.intValue())) {
						Main.TimerIniciando = ReIniciando.intValue();
						Bukkit.broadcastMessage("§7[§a?§7] §7Contagem reiniciada aguardando §a5§7 jogadores.");
						IniciandoEvt.Teleportar = false;
						for (Player pl : Bukkit.getOnlinePlayers()) {
							if (Main.Jogadores.contains(pl.getName())) {
								for (PotionEffect effect : pl.getActivePotionEffects()) {
									pl.removePotionEffect(effect.getType());
								}
							}
						}
					} else {
						Main.IniciarPartida();
					}
				}
			}, 0, 20);
		}
	}

	public static void cancel() {
		if (shed_id != null) {
			Bukkit.getServer().getScheduler().cancelTask(shed_id);
			shed_id = null;
		}
	}
}